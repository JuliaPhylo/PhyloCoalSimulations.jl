<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>more examples · PhyloCoalSimulations.jl</title><script data-outdated-warner src="../../assets/warner.js"></script><link rel="canonical" href="https://cecileane.github.io/PhyloCoalSimulations.jl/man/more_examples/"/><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../">PhyloCoalSimulations.jl</a></span></div><form class="docs-search" action="../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../">home</a></li><li><span class="tocitem">manual</span><ul><li><a class="tocitem" href="../getting_started/">getting started</a></li><li><a class="tocitem" href="../mapping_genetree_to_network/">mapping gene trees into the species network</a></li><li><a class="tocitem" href="../converting_coal2generation_units/">converting between units</a></li><li><a class="tocitem" href="../correlated_inheritance/">correlated inheritance</a></li><li class="is-active"><a class="tocitem" href>more examples</a><ul class="internal"><li><a class="tocitem" href="#counting-deep-coalescences"><span>counting deep coalescences</span></a></li><li><a class="tocitem" href="#number-of-lineages-inherited-via-gene-flow"><span>number of lineages inherited via gene flow</span></a></li><li><a class="tocitem" href="#rate-variation-across-species"><span>rate variation across species</span></a></li></ul></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">manual</a></li><li class="is-active"><a href>more examples</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>more examples</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/cecileane/PhyloCoalSimulations.jl/blob/main/docs/src/man/more_examples.md#" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="example-uses"><a class="docs-heading-anchor" href="#example-uses">example uses</a><a id="example-uses-1"></a><a class="docs-heading-anchor-permalink" href="#example-uses" title="Permalink"></a></h1><p>We are re-using the same network and simulated tree as before:</p><pre><code class="language-julia-repl hljs" style="display:block;">julia&gt; writeTopology(net)</code><code class="nohighlight hljs ansi" style="display:block;">&quot;((C:0.9,(B:0.2)#H1:0.7::0.6)I1:0.6,(#H1:0.6::0.4,A:1.0)I2:0.5)I3;&quot;</code><br/><code class="language-julia-repl hljs" style="display:block;">julia&gt; writeTopology(tree, round=true)</code><code class="nohighlight hljs ansi" style="display:block;">&quot;((((C:0.9)I1:0.6)I3:0.64,((A:1.0)I2:0.5)I3:0.64):1.424,(((B:0.2)H1:0.6)I2:0.5)I3:2.064);&quot;</code></pre><p><img src="../../assets/figures/genetree_example1.svg" alt="example 1, same as in mapping section"/></p><h2 id="counting-deep-coalescences"><a class="docs-heading-anchor" href="#counting-deep-coalescences">counting deep coalescences</a><a id="counting-deep-coalescences-1"></a><a class="docs-heading-anchor-permalink" href="#counting-deep-coalescences" title="Permalink"></a></h2><p>The number of deep coalescences can be quantified as the number of &quot;extra&quot; lineages due to incomplete lineage sorting, that can be calculated from embedding the gene tree into the species phylogeny (see <a href="https://doi.org/10.1093/sysbio/46.3.523">Maddison 1997</a> for species trees). For an edge in the network, say edge 7 going from I2 to I3 going in back in time, lineage sorting is complete if all the gene lineages entering the edge (at I2) coalesce into a single gene lineage by the time they exit the edge (at I3). If they don&#39;t, the number of extra lineages is <code>k-1</code> where <code>k</code> is the number of lineages &quot;exiting&quot; the edge, for that particular edge in the species network and that particular gene tree. The total number of extra lineages, for a given gene tree, is the sum across all edges in the species phylogeny.</p><p>In our gene tree above, we can count the number of lineages that exit each species edge using the degree-2 mapping nodes, then count how many lineages are &quot;extra&quot;. We do so below using utilities <a href="../../#PhyloCoalSimulations.mappingnodes"><code>mappingnodes</code></a> to iterate over degree-2 mapping nodes and <a href="../../#PhyloCoalSimulations.population_mappedto-Tuple{Union{PhyloNetworks.EdgeT{PhyloNetworks.Node}, PhyloNetworks.Node}}"><code>population_mappedto</code></a> to extract the mapping information.</p><pre><code class="language-julia-repl hljs" style="display:block;">julia&gt; # dictionary to store the count of extra lineages exiting each network edge. initialized at 0
       edge_count = Dict(e.number =&gt; 0 for e in net.edge)</code><code class="nohighlight hljs ansi" style="display:block;">Dict{Int64, Int64} with 7 entries:
  5 =&gt; 0
  4 =&gt; 0
  6 =&gt; 0
  7 =&gt; 0
  2 =&gt; 0
  3 =&gt; 0
  1 =&gt; 0</code><br/><code class="language-julia-repl hljs" style="display:block;">julia&gt; const PCS = PhyloCoalSimulations; # for lazy typing!</code><code class="nohighlight hljs ansi" style="display:block;"></code><br/><code class="language-julia-repl hljs" style="display:block;">julia&gt; for n in PCS.mappingnodes(tree)  # iterate over degree-2 mapping nodes in the gene tree
         child = PCS.singlechildedge(n)
         popid = PCS.population_mappedto(child) # number of species edge that &#39;n&#39; came from
         # sanity check below
         isnothing(popid) &amp;&amp; error(&quot;&quot;&quot;population ID not found for the child edge of
                           node number $(n.number) mapping to species node $(n.name).&quot;&quot;&quot;)
         edge_count[popid] += 1 # increment by 1 the number of lineages exiting population edge &#39;popid&#39;
       end</code><code class="nohighlight hljs ansi" style="display:block;"></code><br/><code class="language-julia-repl hljs" style="display:block;">julia&gt; edge_count</code><code class="nohighlight hljs ansi" style="display:block;">Dict{Int64, Int64} with 7 entries:
  5 =&gt; 1
  4 =&gt; 1
  6 =&gt; 1
  7 =&gt; 2
  2 =&gt; 1
  3 =&gt; 0
  1 =&gt; 1</code></pre><p>From this, we see two interesting things.</p><ul><li>0 lineages exited edge number 3 in the species network: it&#39;s the hybrid edge from H1 to I3 (going back in time). That&#39;s because the only lineage at H1 was interited from I2, so there weren&#39;t any lineage evolving through edge 3.</li><li>2 lineages exited edge number 7 (going from I2 to I3 back in time), so that&#39;s 1 extra lineage. All other edges look as expected, with a single gene lineage exiting from them.</li></ul><p>We can now calculate the total number of extra lineages:</p><pre><code class="language-julia-repl hljs" style="display:block;">julia&gt; filter!(p -&gt; p.second &gt; 0, edge_count) # filter out edges without any gene lineage</code><code class="nohighlight hljs ansi" style="display:block;">Dict{Int64, Int64} with 6 entries:
  5 =&gt; 1
  4 =&gt; 1
  6 =&gt; 1
  7 =&gt; 2
  2 =&gt; 1
  1 =&gt; 1</code><br/><code class="language-julia-repl hljs" style="display:block;">julia&gt; map!(k -&gt; k-1, values(edge_count))     # calculate number of &quot;extras&quot;: k-1</code><code class="nohighlight hljs ansi" style="display:block;">ValueIterator for a Dict{Int64, Int64} with 6 entries. Values:
  0
  0
  0
  1
  0
  0</code><br/><code class="language-julia-repl hljs" style="display:block;">julia&gt; deepcoalescence = sum(values(edge_count)) # sum &#39;extras&#39; over all edges in the network</code><code class="nohighlight hljs ansi" style="display:block;">1</code></pre><p>On the particular gene tree we simulated, we counted 1 deep coalescence.</p><h2 id="number-of-lineages-inherited-via-gene-flow"><a class="docs-heading-anchor" href="#number-of-lineages-inherited-via-gene-flow">number of lineages inherited via gene flow</a><a id="number-of-lineages-inherited-via-gene-flow-1"></a><a class="docs-heading-anchor-permalink" href="#number-of-lineages-inherited-via-gene-flow" title="Permalink"></a></h2><p>Our network has inheritance γ=0.4 on the minor edge, which we&#39;ll call the &quot;gene flow&quot; edge, and γ=0.6 on the major hybrid edge, parent to H1 on the major tree. But we may be interested in the realized proportion of lineages inherited from each parent at H1, realized in the gene trees we actually simulated. To do so, we can count the number of gene lineages that are mapped to each hybrid edge in the network.</p><p>This mapping is stored in the edge attribute <code>.inCycle</code> internally, but it&#39;s best to access it via the function <a href="../../#PhyloCoalSimulations.population_mappedto-Tuple{Union{PhyloNetworks.EdgeT{PhyloNetworks.Node}, PhyloNetworks.Node}}"><code>population_mappedto</code></a> (as the internal representation may change). From the plot above, the minor &quot;gene flow&quot; edge is edge number 5 and the major hybrid edge has number 3. So we can count the gene lineages inherited via gene flow as the number of gene tree edges with <code>inCycle</code> equal to 5.</p><p>If the gene trees have been saved to a file and later read from this file, then the <code>.inCycle</code> attributes are no longer stored in memory. In this case, we can retrieve the mapping information by the internal node names. The edges going through gene flow are those whose child node is named &quot;H1&quot; and parent node is named &quot;I2&quot;.</p><p>We use the first option with the <code>.inCycle</code> attribute below. We get that our one simulated gene tree was indeed inherited via gene flow:</p><pre><code class="language-julia-repl hljs" style="display:block;">julia&gt; sum(e.inCycle == 5 for e in tree.edge) # or:</code><code class="nohighlight hljs ansi" style="display:block;">1</code><br/><code class="language-julia-repl hljs" style="display:block;">julia&gt; sum(PCS.population_mappedto(e) == 5 for e in tree.edge)</code><code class="nohighlight hljs ansi" style="display:block;">1</code><br/><code class="language-julia-repl hljs" style="display:block;">julia&gt; # or define a function to do this for any edge, so we can re-use later:
       nlineages_through(edgeID, gt) = sum(PCS.population_mappedto(e) == edgeID for e in gt.edge);</code><code class="nohighlight hljs ansi" style="display:block;"></code><br/><code class="language-julia-repl hljs" style="display:block;">julia&gt; nlineages_through(5, tree) # same as before!</code><code class="nohighlight hljs ansi" style="display:block;">1</code><br/><code class="language-julia-repl hljs" style="display:block;">julia&gt; nlineages_through(3, tree) # lineages that went through edge 3, the major edge.</code><code class="nohighlight hljs ansi" style="display:block;">0</code></pre><p>To make this more interesting, we can simulate many gene trees then count how many of their lineages were inherited via gene flow. If we ask for 2 individuals in species B, then each gene may have 2 lineages that enter the hybrid node H1, if the two B individuals fail to coalesce. In that case, it&#39;s possible that one individual lineage was inherited via gene flow, and the other not. We&#39;ll calculate the gene flow proportion among all these lineages. This proportion should be close (but not exactly equal) to the theoretical γ=0.4 from the network model.</p><pre><code class="language-julia-repl hljs" style="display:block;">julia&gt; ngenes = 100;</code><code class="nohighlight hljs ansi" style="display:block;"></code><br/><code class="language-julia-repl hljs" style="display:block;">julia&gt; genetrees = simulatecoalescent(net, ngenes, Dict(&quot;B&quot;=&gt;2, &quot;A&quot;=&gt;1, &quot;C&quot;=&gt;1); nodemapping=true);</code><code class="nohighlight hljs ansi" style="display:block;"></code><br/><code class="language-julia-repl hljs" style="display:block;">julia&gt; length(genetrees)</code><code class="nohighlight hljs ansi" style="display:block;">100</code><br/><code class="language-julia-repl hljs" style="display:block;">julia&gt; nlineages_geneflow = sum(nlineages_through(5,gt) for gt in genetrees)</code><code class="nohighlight hljs ansi" style="display:block;">70</code><br/><code class="language-julia-repl hljs" style="display:block;">julia&gt; nlineages_major    = sum(nlineages_through(3,gt) for gt in genetrees)</code><code class="nohighlight hljs ansi" style="display:block;">129</code><br/><code class="language-julia-repl hljs" style="display:block;">julia&gt; # realized γ, close to 0.4:
       proportion_geneflow = nlineages_geneflow / (nlineages_geneflow + nlineages_major)</code><code class="nohighlight hljs ansi" style="display:block;">0.35175879396984927</code></pre><h2 id="rate-variation-across-species"><a class="docs-heading-anchor" href="#rate-variation-across-species">rate variation across species</a><a id="rate-variation-across-species-1"></a><a class="docs-heading-anchor-permalink" href="#rate-variation-across-species" title="Permalink"></a></h2><p>The gene trees resulting from <code>simulatecoalescent</code> have their edge lengths in coalescent units. One may want to convert them to substitutions per site, so as to simulate molecular sequences along these gene trees. The mapping information is important to allow for different rates of molecular evolution across different species. Here is an example to do this.</p><p>We will use the <code>Distributions</code> package to simulate rates from a log-normal distribution across species, that is, across edges in the species network.</p><pre><code class="language-julia-repl hljs" style="display:block;">julia&gt; using Distributions</code><code class="nohighlight hljs ansi" style="display:block;"></code><br/><code class="language-julia-repl hljs" style="display:block;">julia&gt; lognormal_rate_dist = LogNormal(-0.125, 0.5) # μ = -σ²/2 to get a mean of 1.</code><code class="nohighlight hljs ansi" style="display:block;">Distributions.LogNormal{Float64}(μ=-0.125, σ=0.5)</code><br/><code class="language-julia-repl hljs" style="display:block;">julia&gt; networkedge_rate = Dict(e.number =&gt; rand(lognormal_rate_dist) for e in net.edge)</code><code class="nohighlight hljs ansi" style="display:block;">Dict{Int64, Float64} with 7 entries:
  5 =&gt; 0.68631
  4 =&gt; 1.23458
  6 =&gt; 1.84251
  7 =&gt; 0.438
  2 =&gt; 1.43724
  3 =&gt; 1.09321
  1 =&gt; 0.580741</code><br/><code class="language-julia-repl hljs" style="display:block;">julia&gt; # add entry for the edge above the network&#39;s root. Find its number first.
       rootedgenumber = PhyloCoalSimulations.get_rootedgenumber(net)</code><code class="nohighlight hljs ansi" style="display:block;">8</code><br/><code class="language-julia-repl hljs" style="display:block;">julia&gt; push!(networkedge_rate, rootedgenumber =&gt; rand(lognormal_rate_dist))</code><code class="nohighlight hljs ansi" style="display:block;">Dict{Int64, Float64} with 8 entries:
  5 =&gt; 0.68631
  4 =&gt; 1.23458
  6 =&gt; 1.84251
  7 =&gt; 0.438
  2 =&gt; 1.43724
  8 =&gt; 1.39978
  3 =&gt; 1.09321
  1 =&gt; 0.580741</code><br/><code class="language-julia-repl hljs" style="display:block;">julia&gt; writeTopology(tree, round=true, digits=4) # before rate variation</code><code class="nohighlight hljs ansi" style="display:block;">&quot;((((C:0.9)I1:0.6)I3:0.64,((A:1.0)I2:0.5)I3:0.64):1.4235,(((B:0.2)H1:0.6)I2:0.5)I3:2.0636);&quot;</code><br/><code class="language-julia-repl hljs" style="display:block;">julia&gt; # multiply the length of each gene lineage by the rate of the species edge it maps into
       for e in tree.edge
         e.length *= networkedge_rate[e.inCycle]
       end</code><code class="nohighlight hljs ansi" style="display:block;"></code><br/><code class="language-julia-repl hljs" style="display:block;">julia&gt; writeTopology(tree, round=true, digits=4) # after rate variation</code><code class="nohighlight hljs ansi" style="display:block;">&quot;((((C:0.5227)I1:0.7407)I3:0.8959,((A:1.8425)I2:0.219)I3:0.8959):1.9926,(((B:0.2874)H1:0.4118)I2:0.219)I3:2.8885);&quot;</code></pre></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../correlated_inheritance/">« correlated inheritance</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.23 on <span class="colophon-date" title="Sunday 15 January 2023 00:10">Sunday 15 January 2023</span>. Using Julia version 1.8.5.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
